# Curve 이벤트 발행 라이브러리 설정 예시

# =====================================
# 기본 설정 (프로덕션 환경)
# =====================================
curve:
  # Curve 활성화 여부 (기본값: true)
  enabled: true

  # ===== ID Generator 설정 =====
  id-generator:
    # Snowflake Worker ID (0 ~ 1023)
    # 분산 환경에서 각 인스턴스마다 고유한 값을 설정해야 함
    worker-id: 1

    # Worker ID 자동 생성 (MAC 주소 기반)
    # 주의: 가상 환경에서는 충돌 가능성이 있으므로 프로덕션에서는 권장하지 않음
    auto-generate: false

  # ===== Kafka 설정 =====
  kafka:
    # 메인 이벤트 토픽
    topic: event.audit.v1

    # Dead Letter Queue 토픽 (선택사항)
    # 설정하지 않으면 DLQ 기능이 비활성화됨
    dlq-topic: event.audit.dlq.v1

    # Kafka Producer 재시도 횟수
    retries: 3

    # 재시도 백오프 시간 (ms)
    retry-backoff-ms: 1000

    # 요청 타임아웃 (ms)
    request-timeout-ms: 30000

    # ===== 비동기 전송 설정 =====
    # 비동기 모드 활성화 여부
    # true: 비동기 전송 (높은 성능, non-blocking)
    # false: 동기 전송 (낮은 성능, 전송 보장)
    async-mode: false

    # 비동기 전송 타임아웃 (ms)
    # async-mode가 true일 때만 사용
    async-timeout-ms: 5000

    # DLQ 전송 전용 스레드 풀 크기 (기본값: 2)
    # 비동기 모드에서 DLQ 전송 시 콜백 스레드 블로킹 방지
    dlq-executor-threads: 2

    # ===== 보안 설정 =====
    # 프로덕션 환경 여부 (기본값: false)
    # true: DLQ 백업 파일 보안 실패 시 예외 발생 (권장)
    # false: 개발 모드 - 보안 실패 시 경고만 출력
    # 주의: 프로덕션 환경에서는 반드시 true로 설정
    #       Windows 환경에서는 ACL 지원 필수, POSIX 시스템 권장
    is-production: false

  # ===== Retry 설정 =====
  retry:
    # 재시도 활성화 여부
    enabled: true

    # 최대 재시도 횟수
    max-attempts: 3

    # 초기 재시도 지연 시간 (ms)
    initial-interval: 1000

    # 재시도 지연 시간 배수 (Exponential Backoff)
    # 예: 1초 -> 2초 -> 4초
    multiplier: 2.0

    # 최대 재시도 지연 시간 (ms)
    max-interval: 10000

  # ===== AOP 설정 =====
  aop:
    # @PublishEvent 어노테이션 AOP 활성화 여부
    enabled: true

  # ===== 보안 설정 =====
  security:
    # X-Forwarded-For 헤더 사용 여부 (기본값: false)
    # 프록시/로드밸런서 뒤에서 실행되는 경우에만 true로 설정
    # 주의: 신뢰할 수 없는 환경에서는 false로 유지 (보안 취약점)
    use-forwarded-headers: false

# =====================================
# Spring Boot 기본 설정
# =====================================
server:
  # 프록시 헤더 처리 전략
  # - none: 프록시 헤더 무시 (기본값, 가장 안전)
  # - native: 서버의 네이티브 프록시 헤더 처리 사용
  # - framework: Spring의 ForwardedHeaderFilter 사용 (권장)
  forward-headers-strategy: none

# Kafka 설정
spring:
  kafka:
    bootstrap-servers: localhost:9094
    producer:
      acks: all
      key-serializer: org.apache.kafka.common.serialization.StringSerializer
      value-serializer: org.apache.kafka.common.serialization.StringSerializer

---
# =====================================
# 개발 환경 설정
# =====================================
spring:
  config:
    activate:
      on-profile: dev

curve:
  id-generator:
    worker-id: 1
    auto-generate: false

  kafka:
    topic: event.audit.dev.v1
    dlq-topic: event.audit.dlq.dev.v1
    async-mode: true  # 개발 환경에서는 빠른 테스트를 위해 비동기
    async-timeout-ms: 3000
    retries: 3

  retry:
    enabled: true
    max-attempts: 3
    initial-interval: 500
    multiplier: 1.5
    max-interval: 5000

---
# =====================================
# 고성능 환경 설정
# =====================================
spring:
  config:
    activate:
      on-profile: high-performance

curve:
  id-generator:
    worker-id: ${WORKER_ID:1}  # 환경변수에서 주입
    auto-generate: false

  kafka:
    topic: event.audit.v1
    dlq-topic: event.audit.dlq.v1
    async-mode: true  # 비동기 전송으로 높은 처리량 확보
    async-timeout-ms: 5000
    retries: 1  # 최소 재시도로 레이턴시 감소

  retry:
    enabled: false  # 재시도 비활성화 (성능 우선)

---
# =====================================
# 안정성 우선 환경 설정
# =====================================
spring:
  config:
    activate:
      on-profile: high-reliability

curve:
  id-generator:
    worker-id: ${WORKER_ID:1}
    auto-generate: false

  kafka:
    topic: event.audit.v1
    dlq-topic: event.audit.dlq.v1
    async-mode: false  # 동기 전송으로 전송 보장
    retries: 5
    retry-backoff-ms: 2000
    request-timeout-ms: 60000

  retry:
    enabled: true
    max-attempts: 5
    initial-interval: 2000
    multiplier: 2.0
    max-interval: 30000

---
# =====================================
# Kubernetes 환경 설정 예시
# =====================================
spring:
  config:
    activate:
      on-profile: k8s

curve:
  id-generator:
    # Pod Ordinal을 Worker ID로 사용 (StatefulSet)
    # 예: my-app-0 -> 0, my-app-1 -> 1
    worker-id: ${POD_ORDINAL:1}
    auto-generate: false

  kafka:
    topic: event.audit.v1
    dlq-topic: event.audit.dlq.v1
    async-mode: true
    async-timeout-ms: 5000

---
# =====================================
# 프록시 환경 설정 (Nginx, AWS ALB, GCP Load Balancer 등)
# =====================================
spring:
  config:
    activate:
      on-profile: behind-proxy

curve:
  security:
    # 프록시 뒤에서 실행되므로 X-Forwarded-For 헤더 사용
    use-forwarded-headers: true

# Spring Boot의 ForwardedHeaderFilter 활성화
server:
  forward-headers-strategy: framework

  # Tomcat 프록시 설정 (프로덕션 필수)
  tomcat:
    remoteip:
      # 신뢰할 수 있는 프록시 IP 패턴 (정규식)
      # 예: 10.0.0.0/8, 192.168.0.0/16, 172.16.0.0/12
      internal-proxies: 10\\.\\d{1,3}\\.\\d{1,3}\\.\\d{1,3}|192\\.168\\.\\d{1,3}\\.\\d{1,3}|172\\.(1[6-9]|2[0-9]|3[0-1])\\.\\d{1,3}\\.\\d{1,3}

      # X-Forwarded-Proto 헤더 이름
      protocol-header: X-Forwarded-Proto

      # X-Forwarded-For 헤더 이름
      remote-ip-header: X-Forwarded-For

      # 포트 헤더 이름 (선택)
      port-header: X-Forwarded-Port

---
# =====================================
# AWS 환경 설정 (ALB/ELB 뒤)
# =====================================
spring:
  config:
    activate:
      on-profile: aws

curve:
  id-generator:
    worker-id: ${AWS_CONTAINER_CREDENTIALS_RELATIVE_URI:1}  # ECS Task ID 사용
    auto-generate: false

  security:
    use-forwarded-headers: true

server:
  forward-headers-strategy: framework
  tomcat:
    remoteip:
      # AWS ALB/ELB의 프라이빗 IP 대역
      internal-proxies: 10\\.\\d{1,3}\\.\\d{1,3}\\.\\d{1,3}|172\\.(1[6-9]|2[0-9]|3[0-1])\\.\\d{1,3}\\.\\d{1,3}
      protocol-header: X-Forwarded-Proto
      remote-ip-header: X-Forwarded-For

---
# =====================================
# 로컬 개발 환경 (프록시 없음)
# =====================================
spring:
  config:
    activate:
      on-profile: local

curve:
  security:
    # 로컬 환경에서는 프록시 헤더 사용 안 함
    use-forwarded-headers: false

server:
  # 로컬에서는 프록시 헤더 처리 비활성화
  forward-headers-strategy: none

---
# =====================================
# Transactional Outbox Pattern 설정
# =====================================
spring:
  config:
    activate:
      on-profile: outbox

curve:
  # ===== Outbox Pattern 설정 =====
  outbox:
    # Outbox Pattern 활성화 여부 (기본값: false)
    # true: DB 트랜잭션과 이벤트 발행의 원자성 보장
    enabled: true

    # Outbox 이벤트 발행기 활성화 여부 (기본값: true)
    # true: 애플리케이션 내에서 주기적으로 PENDING 이벤트를 Kafka로 발행
    # false: DB 저장만 수행 (CDC 사용 시)
    publisher-enabled: true

    # 테이블 스키마 초기화 모드 (embedded/always/never)
    # embedded: 임베디드 DB에서만 자동 생성
    # always: 항상 자동 생성 (테이블이 없을 때만)
    # never: 수동 관리 (Flyway/Liquibase 권장)
    initialize-schema: embedded

    # 폴링 주기 (ms)
    poll-interval-ms: 1000

    # 배치 크기 (한 번에 처리할 이벤트 수)
    batch-size: 100

    # 최대 재시도 횟수
    max-retries: 3

    # Kafka 전송 타임아웃 (초)
    send-timeout-seconds: 10

    # ===== 자동 정리 설정 =====
    # PUBLISHED 이벤트 자동 정리 활성화
    cleanup-enabled: true

    # 보관 기간 (일)
    retention-days: 7

    # 정리 작업 실행 주기 (cron)
    cleanup-cron: "0 0 2 * * *"  # 매일 새벽 2시

    # ===== 확장성 개선 설정 (NEW!) =====
    # 동적 배치 크기 조정 활성화 (기본값: true)
    # pending 이벤트 수에 따라 배치 크기를 자동 조정하여 처리량 증가
    # - pending > 1000: batchSize * 2 (최대 500)
    # - pending > 500: batchSize * 1.5 (최대 300)
    # - pending < 10: min(batchSize, 10)
    dynamic-batching-enabled: true

    # Circuit Breaker 활성화 (기본값: true)
    # Kafka 장애 감지 시 자동으로 요청 차단하여 시스템 보호
    # - 연속 5회 실패 시 Circuit OPEN
    # - 1분 후 Half-Open 상태로 전환하여 복구 시도
    circuit-breaker-enabled: true

  kafka:
    # Outbox에서는 프로덕션 모드 권장
    is-production: true
