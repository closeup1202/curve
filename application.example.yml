# Curve Event Publishing Library Configuration Example

# =====================================
# Default Configuration (Production)
# =====================================
curve:
  # Enable/disable Curve (default: true)
  enabled: true

  # ===== ID Generator Settings =====
  id-generator:
    # Snowflake Worker ID (0 ~ 1023)
    # Must be unique per instance in distributed environments
    worker-id: 1

    # Auto-generate Worker ID (MAC address based)
    # Warning: May cause collisions in virtual environments, not recommended for production
    auto-generate: false

  # ===== Kafka Settings =====
  kafka:
    # Main event topic
    topic: event.audit.v1

    # Dead Letter Queue topic (optional)
    # DLQ is disabled if not configured
    dlq-topic: event.audit.dlq.v1

    # Kafka Producer retry count
    retries: 3

    # Retry backoff time (ms)
    retry-backoff-ms: 1000

    # Request timeout (ms)
    request-timeout-ms: 30000

    # ===== Async Send Settings =====
    # Enable async mode
    # true: Asynchronous sending (high performance, non-blocking)
    # false: Synchronous sending (lower performance, delivery guarantee)
    async-mode: false

    # Async send timeout (ms)
    # Only used when async-mode is true
    async-timeout-ms: 5000

    # DLQ executor thread pool size (default: 2)
    # Prevents callback thread blocking during async DLQ sends
    dlq-executor-threads: 2

    # ===== Security Settings =====
    # Production environment flag (default: false)
    # true: Throws exception on DLQ backup file security failure (recommended)
    # false: Development mode - only logs warnings on security failure
    # Warning: Must be true in production environments
    #          Windows requires ACL support, POSIX systems recommended
    is-production: false

  # ===== Retry Settings =====
  retry:
    # Enable retry
    enabled: true

    # Maximum retry attempts
    max-attempts: 3

    # Initial retry delay (ms)
    initial-interval: 1000

    # Retry delay multiplier (Exponential Backoff)
    # Example: 1s -> 2s -> 4s
    multiplier: 2.0

    # Maximum retry delay (ms)
    max-interval: 10000

  # ===== AOP Settings =====
  aop:
    # Enable @PublishEvent annotation AOP
    enabled: true

  # ===== Security Settings =====
  security:
    # Use X-Forwarded-For header (default: false)
    # Only set to true when running behind proxy/load balancer
    # Warning: Keep false in untrusted environments (security vulnerability)
    use-forwarded-headers: false

# =====================================
# Spring Boot Default Settings
# =====================================
server:
  # Proxy header handling strategy
  # - none: Ignore proxy headers (default, most secure)
  # - native: Use server's native proxy header handling
  # - framework: Use Spring's ForwardedHeaderFilter (recommended)
  forward-headers-strategy: none

# Kafka Configuration
spring:
  kafka:
    bootstrap-servers: localhost:9094
    producer:
      acks: all
      key-serializer: org.apache.kafka.common.serialization.StringSerializer
      value-serializer: org.apache.kafka.common.serialization.StringSerializer

---
# =====================================
# Development Environment Configuration
# =====================================
spring:
  config:
    activate:
      on-profile: dev

curve:
  id-generator:
    worker-id: 1
    auto-generate: false

  kafka:
    topic: event.audit.dev.v1
    dlq-topic: event.audit.dlq.dev.v1
    async-mode: true  # Async for faster testing in dev
    async-timeout-ms: 3000
    retries: 3

  retry:
    enabled: true
    max-attempts: 3
    initial-interval: 500
    multiplier: 1.5
    max-interval: 5000

---
# =====================================
# High Performance Configuration
# =====================================
spring:
  config:
    activate:
      on-profile: high-performance

curve:
  id-generator:
    worker-id: ${WORKER_ID:1}  # Inject from environment variable
    auto-generate: false

  kafka:
    topic: event.audit.v1
    dlq-topic: event.audit.dlq.v1
    async-mode: true  # Async for high throughput
    async-timeout-ms: 5000
    retries: 1  # Minimal retries for low latency

  retry:
    enabled: false  # Disabled for performance priority

---
# =====================================
# High Reliability Configuration
# =====================================
spring:
  config:
    activate:
      on-profile: high-reliability

curve:
  id-generator:
    worker-id: ${WORKER_ID:1}
    auto-generate: false

  kafka:
    topic: event.audit.v1
    dlq-topic: event.audit.dlq.v1
    async-mode: false  # Sync for delivery guarantee
    retries: 5
    retry-backoff-ms: 2000
    request-timeout-ms: 60000

  retry:
    enabled: true
    max-attempts: 5
    initial-interval: 2000
    multiplier: 2.0
    max-interval: 30000

---
# =====================================
# Kubernetes Environment Configuration
# =====================================
spring:
  config:
    activate:
      on-profile: k8s

curve:
  id-generator:
    # Use Pod Ordinal as Worker ID (StatefulSet)
    # Example: my-app-0 -> 0, my-app-1 -> 1
    worker-id: ${POD_ORDINAL:1}
    auto-generate: false

  kafka:
    topic: event.audit.v1
    dlq-topic: event.audit.dlq.v1
    async-mode: true
    async-timeout-ms: 5000

---
# =====================================
# Proxy Environment Configuration (Nginx, AWS ALB, GCP Load Balancer, etc.)
# =====================================
spring:
  config:
    activate:
      on-profile: behind-proxy

curve:
  security:
    # Use X-Forwarded-For header when running behind proxy
    use-forwarded-headers: true

# Enable Spring Boot's ForwardedHeaderFilter
server:
  forward-headers-strategy: framework

  # Tomcat proxy settings (required for production)
  tomcat:
    remoteip:
      # Trusted proxy IP patterns (regex)
      # Example: 10.0.0.0/8, 192.168.0.0/16, 172.16.0.0/12
      internal-proxies: 10\.\d{1,3}\.\d{1,3}\.\d{1,3}|192\.168\.\d{1,3}\.\d{1,3}|172\.(1[6-9]|2[0-9]|3[0-1])\.\d{1,3}\.\d{1,3}

      # X-Forwarded-Proto header name
      protocol-header: X-Forwarded-Proto

      # X-Forwarded-For header name
      remote-ip-header: X-Forwarded-For

      # Port header name (optional)
      port-header: X-Forwarded-Port

---
# =====================================
# AWS Environment Configuration (Behind ALB/ELB)
# =====================================
spring:
  config:
    activate:
      on-profile: aws

curve:
  id-generator:
    worker-id: ${AWS_CONTAINER_CREDENTIALS_RELATIVE_URI:1}  # Use ECS Task ID
    auto-generate: false

  security:
    use-forwarded-headers: true

server:
  forward-headers-strategy: framework
  tomcat:
    remoteip:
      # AWS ALB/ELB private IP ranges
      internal-proxies: 10\.\d{1,3}\.\d{1,3}\.\d{1,3}|172\.(1[6-9]|2[0-9]|3[0-1])\.\d{1,3}\.\d{1,3}
      protocol-header: X-Forwarded-Proto
      remote-ip-header: X-Forwarded-For

---
# =====================================
# Local Development Environment (No Proxy)
# =====================================
spring:
  config:
    activate:
      on-profile: local

curve:
  security:
    # Don't use proxy headers in local environment
    use-forwarded-headers: false

server:
  # Disable proxy header handling in local
  forward-headers-strategy: none

---
# =====================================
# Transactional Outbox Pattern Configuration
# =====================================
spring:
  config:
    activate:
      on-profile: outbox

curve:
  # ===== Outbox Pattern Settings =====
  outbox:
    # Enable Outbox Pattern (default: false)
    # true: Guarantees atomicity between DB transaction and event publishing
    enabled: true

    # Enable Outbox event publisher (default: true)
    # true: Periodically publish PENDING events to Kafka within application
    # false: Only save to DB (when using CDC)
    publisher-enabled: true

    # Table schema initialization mode (embedded/always/never)
    # embedded: Auto-create only for embedded DB
    # always: Always auto-create (only when table doesn't exist)
    # never: Manual management (Flyway/Liquibase recommended)
    initialize-schema: embedded

    # Polling interval (ms)
    poll-interval-ms: 1000

    # Batch size (events to process per cycle)
    batch-size: 100

    # Maximum retry attempts
    max-retries: 3

    # Kafka send timeout (seconds)
    send-timeout-seconds: 10

    # ===== Auto Cleanup Settings =====
    # Enable auto cleanup of PUBLISHED events
    cleanup-enabled: true

    # Retention period (days)
    retention-days: 7

    # Cleanup job schedule (cron)
    cleanup-cron: "0 0 2 * * *"  # Daily at 2 AM

    # ===== Scalability Enhancement Settings =====
    # Enable dynamic batch sizing (default: true)
    # Automatically adjusts batch size based on pending event count
    # - pending > 1000: batchSize * 2 (max 500)
    # - pending > 500: batchSize * 1.5 (max 300)
    # - pending < 10: min(batchSize, 10)
    dynamic-batching-enabled: true

    # Enable Circuit Breaker (default: true)
    # Automatically blocks requests when Kafka failure detected to protect system
    # - Circuit OPEN after 5 consecutive failures
    # - Transitions to Half-Open after 1 minute for recovery attempt
    circuit-breaker-enabled: true

  kafka:
    # Production mode recommended for Outbox
    is-production: true
